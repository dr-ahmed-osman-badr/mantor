{% extends 'life_manager/base.html' %}

{% block content %}
<div class="space-y-8">

    <!-- 1. Header & Context Status -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                {% if context %}
                Context Active
                {% else %}
                New Context
                {% endif %}
            </h1>
            <p class="text-gray-400 mt-1">
                {% if context %}
                <span class="text-green-400"><i class="fa-solid fa-circle text-[8px] align-middle mr-1"></i>Live</span>
                Signature: <span class="font-mono text-xs bg-gray-800 px-2 py-1 rounded">{{ context.unique_signature
                    }}</span>
                {% else %}
                Select options to generate a context.
                {% endif %}
            </p>
        </div>

        <!-- Context Pills (Grouped) -->
        <div class="flex flex-col gap-3 items-end md:items-start">
            {% regroup selected_options by group.name as grouped_options %}
            {% for group_item in grouped_options %}
            <div class="flex flex-col items-end md:items-start gap-1">
                <span class="text-[10px] uppercase tracking-widest text-gray-500 font-bold ml-1">{{
                    group_item.grouper }}</span>
                <div class="flex flex-wrap gap-2 justify-end md:justify-start">
                    {% for opt in group_item.list %}
                    <span
                        class="px-3 py-1 rounded-full text-xs font-semibold bg-primary/20 text-primary border border-primary/30 flex items-center gap-2">
                        <i class="fa-solid {{ opt.icon|default:'fa-tag' }}"></i>
                        {% if opt.category %}
                        <span class="opacity-70">{{ opt.category.name }} &rsaquo;</span>
                        {% endif %}
                        {{ opt.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <span class="text-gray-600 text-sm italic">No context selected</span>
            {% endfor %}
        </div>
    </div>

    <!-- 2. Quick Actions (Presets) -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
        {% for preset in presets %}
        <a href="?preset={{ preset.id }}"
            class="group glass rounded-xl p-4 hover:bg-gray-700/50 transition-all border-l-4 border-transparent hover:border-primary">
            <div class="flex flex-col items-center text-center gap-2">
                <i
                    class="fa-solid {{ preset.icon }} text-xl group-hover:text-white text-gray-400 transition-colors"></i>
                <span class="text-xs font-medium text-gray-300 group-hover:text-white">{{ preset.name }}</span>
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- 3. Main Control Panel & Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- LEFT: Context Selector -->
        <div class="lg:col-span-1 space-y-6">

            <!-- Gamification / Profile Card -->
            <div class="glass p-6 rounded-3xl relative overflow-hidden group">
                <div
                    class="absolute -top-10 -right-10 w-32 h-32 bg-primary/20 rounded-full blur-3xl group-hover:bg-primary/30 transition-all">
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                            M
                        </div>
                        <div>
                            <h2 class="font-bold text-white text-lg">My Profile</h2>
                            <div class="flex items-center gap-2 text-xs text-secondary font-mono">
                                <i class="fa-solid fa-star text-yellow-500"></i> {{ gamification.total_points }} XP
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Badges -->
                <div class="flex gap-2 mb-4 flex-wrap">
                    {% for badge in gamification.badges %}
                    <div class="bg-dark/50 rounded-lg px-2 py-1 flex items-center gap-2 border border-gray-700/50"
                        title="{{ badge.name }}">
                        <i class="fa-solid {{ badge.icon }} {{ badge.color }} text-xs"></i>
                        <span class="text-[10px] text-gray-300">{{ badge.name }}</span>
                    </div>
                    {% empty %}
                    <span class="text-[10px] text-gray-500">No badges yet. Keep going!</span>
                    {% endfor %}
                </div>

                <!-- Active Streaks -->
                {% if streaks %}
                <div class="space-y-2">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Active Streaks</h3>
                    {% for streak in streaks %}
                    <div class="flex items-center justify-between bg-dark/30 rounded-lg p-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded bg-orange-500/10 flex items-center justify-center">
                                <i class="fa-solid {{ streak.icon }} text-orange-500 text-xs"></i>
                            </div>
                            <span class="text-sm text-gray-200">{{ streak.name }}</span>
                        </div>
                        <div class="flex items-center gap-1 text-orange-400 font-bold text-sm">
                            {{ streak.streak }} <i class="fa-solid fa-fire animate-pulse"></i>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="glass rounded-2xl p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-pink-500"></i> Adjust Reality
                </h2>
                <form method="get" action="{% url 'life_manager:dashboard' %}" class="space-y-4">
                    {% for group in groups %}
                    <div>
                        <label class="text-xs font-medium text-gray-400 uppercase tracking-wider mb-2 block">{{
                            group.name }}</label>
                        <select name="options"
                            class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                            <option value="">-- Any --</option>
                            {% for opt in group.statusoption_set.all %}
                            <option value="{{ opt.id }}" {% if opt.id in selected_ids %}selected{% endif %}>
                                {{ opt.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endfor %}
                    <button type="submit"
                        class="w-full bg-primary hover:bg-secondary text-white font-medium py-2 rounded-lg transition-colors mt-2">
                        Update Context
                    </button>
                </form>
            </div>
        </div>

        <!-- Add New Option (Expand World) -->
        <div class="glass rounded-2xl p-6">
            <h2 class="text-sm font-semibold mb-3 text-gray-400 flex items-center gap-2">
                <i class="fa-solid fa-plus-circle text-gray-500"></i> Expand Your World
            </h2>
            <form onsubmit="handleApiSubmit(event, 'options/')" class="space-y-3">
                {% csrf_token %}
                <!-- 1. Group Selection -->
                <div>
                    <select id="groupSelect" name="group_id" required
                        class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-primary outline-none"
                        onchange="filterCategories()">
                        <option value="" disabled selected>Select Group...</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 2. Category Selection (Dependent) -->
                <div>
                    <select id="categorySelect" name="category_id"
                        class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-primary outline-none disabled:opacity-50"
                        disabled onchange="filterSubCategories()">
                        <option value="">-- Select Category (Optional) --</option>
                        {% for group in groups %}
                        {% for cat in group.categories.all %}
                        {% if not cat.parent %}
                        <option value="{{ cat.id }}" data-group-id="{{ group.id }}" hidden>
                            {{ cat.name }}
                        </option>
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                    </select>
                </div>

                <!-- 3. Sub-Category Selection (Dependent on Category) -->
                <div id="subCatContainer" class="hidden">
                    <select id="subCategorySelect" name="subcategory_id"
                        class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-primary outline-none disabled:opacity-50"
                        disabled>
                        <option value="">-- Select Sub-Category --</option>
                        {% for group in groups %}
                        {% for cat in group.categories.all %}
                        {% for sub in cat.subcategories.all %}
                        <option value="{{ sub.id }}" data-parent-id="{{ cat.id }}" hidden>
                            {{ sub.name }}
                        </option>
                        {% endfor %}
                        {% endfor %}
                        {% endfor %}
                    </select>
                </div>

                <!-- JS for dependency -->
                <script>
                    function filterCategories() {
                        const groupId = document.getElementById('groupSelect').value;
                        const catSelect = document.getElementById('categorySelect');
                        const options = catSelect.querySelectorAll('option[data-group-id]');

                        // Reset
                        catSelect.value = "";
                        catSelect.disabled = !groupId;

                        // Show/Hide based on group
                        let hasOptions = false;
                        options.forEach(opt => {
                            if (opt.getAttribute('data-group-id') == groupId) {
                                opt.hidden = false;
                                hasOptions = true;
                            } else {
                                opt.hidden = true;
                            }
                        });

                        if (!hasOptions) {
                            catSelect.disabled = true;
                        }
                    }

                    // --- API Submission Logic ---
                    async function handleApiSubmit(event, endpoint, method = 'POST') {
                        event.preventDefault();
                        const form = event.target;
                        const formData = new FormData(form);
                        const data = {};

                        // Convert FormData to JSON, handling types sparingly
                        formData.forEach((value, key) => {
                            if (value !== "") {
                                data[key] = value;
                            }
                        });

                        // Special mapping for field names if needed (e.g. rename input 'group_id' to 'group')
                        // For Add Option: group_id -> group, category_id -> category
                        if (endpoint.includes('options')) {
                            if (data.group_id) { data.group = data.group_id; delete data.group_id; }
                            if (data.category_id) { data.category = data.category_id; delete data.category_id; }
                        }

                        // For Add Goal: linked_option_id -> linked_option
                        if (endpoint.includes('goals')) {
                            if (data.linked_option_id) { data.linked_option = data.linked_option_id; delete data.linked_option_id; }
                            // Add active context if not specific option linked? logic remains same as view
                            // If we have a context active, we should ideally link it.
                            {% if context %}
                            if (!data.context) { data.context = {{ context.id } };
                        }
                        {% endif %}
                    }

                    // For Add Note
                    if (endpoint.includes('notes')) {
                        {% if context %}
                        if (!data.context) { data.context = {{ context.id } };
                    }
                    {% endif %}
                    // We don't need unique_signature for the API, just the context ID (which we added above)
                    delete data.unique_signature; 
                        }

                    try {
                        const response = await fetch(`/life_manager/${endpoint}`, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            window.location.reload();
                        } else {
                            const err = await response.json();
                            alert('Error: ' + JSON.stringify(err));
                        }
                    } catch (error) {
                        console.error(error);
                        alert('Network error.');
                    }
                    }

                    async function markGoalAchieved(goalId) {
                        try {
                            const response = await fetch(`/life_manager/goals/${goalId}/`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ is_completed: true })
                            });
                            if (response.ok) {
                                window.location.reload();
                            }
                        } catch (e) { console.error(e); }
                    }
                </script>
                <div>
                    <input type="text" name="category_name" placeholder="Or New Category (e.g. Work)"
                        class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-primary outline-none">
                </div>
                <div class="flex gap-2">
                    <input type="text" name="name" placeholder="Name (e.g. Project Alpha)" required
                        class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-primary outline-none">
                    <button type="submit"
                        class="bg-gray-700 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors">
                        <i class="fa-solid fa-check"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Add Target (Goal) -->
        <div class="glass rounded-2xl p-6">
            <h2 class="text-sm font-semibold mb-3 text-gray-400 flex items-center gap-2">
                <i class="fa-solid fa-crosshairs text-red-500"></i> Set Target
            </h2>
            <form onsubmit="handleApiSubmit(event, 'goals/')" class="space-y-3">
                <input type="text" name="title" placeholder="Target (e.g. Drink Water)" required
                    class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-primary outline-none text-white">

                <div class="flex gap-2">
                    <select name="linked_option_id" required
                        class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-primary outline-none">
                        <option value="" disabled selected>-- Link to Item --</option>
                        {% for group in groups %}
                        <optgroup label="{{ group.name }}">
                            {% for opt in group.statusoption_set.all %}
                            <option value="{{ opt.id }}">{{ opt.name }}</option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>

                    <select name="importance"
                        class="w-24 bg-dark border border-gray-700 rounded-lg px-2 py-2 text-xs focus:ring-2 focus:ring-primary outline-none">
                        <option value="1">Low</option>
                        <option value="2" selected>Med</option>
                        <option value="3">High</option>
                        <option value="4">Crit</option>
                    </select>

                    <button type="submit"
                        class="bg-gray-700 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- RIGHT: Dashboard Content -->
    <div class="lg:col-span-2 space-y-6">

        <!-- A. AI Insights Section -->
        {% if recommendations %}
        <div class="space-y-4">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles text-purple-500"></i> AI Insights
            </h2>
            <div class="grid gap-3">
                {% for rec in recommendations %}
                <div class="glass p-5 rounded-2xl relative overflow-hidden group border border-purple-500/20">
                    <div class="absolute top-0 right-0 p-3 opacity-50 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px] uppercase font-bold px-2 py-1 rounded bg-black/30 text-gray-300">
                            {{ rec.get_priority_display }} Priority
                        </span>
                    </div>
                    <h3 class="font-bold text-lg text-white mb-1">{{ rec.title }}</h3>
                    <p class="text-sm text-gray-400 mb-3 italic">{{ rec.summary }}</p>
                    <div class="bg-dark/40 rounded-lg p-3 text-sm text-gray-200 border-l-2 border-purple-500">
                        {{ rec.recommendation }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        {% if context %}
        <div class="space-y-4 opacity-50">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles text-purple-500"></i> AI Insights
            </h2>
            <div class="glass p-5 rounded-2xl border-dashed border-2 border-purple-500/30 text-center">
                <p class="text-sm text-gray-400 italic">No AI insights generated for this context yet.</p>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- B. Goals Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-bullseye text-green-500"></i> Focused Goals
                <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded-full">{{ goals.count }}</span>
            </h2>

            {% if not goals %}
            <div class="text-center py-12 glass rounded-2xl border-dashed border-2 border-gray-700">
                <i class="fa-solid fa-check-circle text-4xl text-gray-600 mb-3"></i>
                <p class="text-gray-400">All clear! No goals for this context.</p>
            </div>
            {% endif %}

            <div class="grid gap-3">
                {% for goal in goals %}
                <div
                    class="glass p-4 rounded-xl flex items-center justify-between group hover:border-primary/50 transition-colors">
                    <div class="flex items-start gap-3">
                        <!-- Priority Indicator -->
                        <div class="mt-1 h-2 w-2 rounded-full 
                                {% if goal.importance == 4 %}bg-red-500 animate-pulse{% elif goal.importance == 3 %}bg-orange-400{% elif goal.importance == 2 %}bg-blue-400{% else %}bg-gray-400{% endif %}"
                            title="{{ goal.get_importance_display }}">
                        </div>

                        <div>
                            <h3 class="font-medium text-gray-200 group-hover:text-white transition-colors">{{
                                goal.title }}</h3>
                            <p class="text-xs text-gray-500">
                                {% if goal.linked_option %}
                                <i class="fa-solid fa-link"></i> Linked to {{ goal.linked_option.name }}
                                {% elif goal.context %}
                                <i class="fa-solid fa-layer-group"></i> Exclusive to this Context
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <button onclick="markGoalAchieved({{ goal.id }})"
                        class="opacity-0 group-hover:opacity-100 bg-green-500/10 hover:bg-green-500 text-green-500 hover:text-white px-3 py-1 rounded text-xs font-medium transition-all transform translate-x-2 group-hover:translate-x-0">
                        Complete
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
            <i class="fa-solid fa-book-open text-blue-500"></i> Context Memory
        </h2>

        <!-- Quick Add Article Form -->
        {% if context %}
        <div class="glass p-4 rounded-xl border border-blue-500/20">
            <form onsubmit="handleApiSubmit(event, 'notes/')">
                <input type="text" name="title" placeholder="New Note Title..." required
                    class="w-full bg-transparent text-white font-semibold mb-2 focus:outline-none placeholder-gray-500">
                <textarea name="content" placeholder="Write something about this context..." rows="2" required
                    class="w-full bg-dark/50 rounded-lg p-2 text-sm text-gray-300 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
                <div class="text-right mt-2">
                    <button type="submit"
                        class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors">
                        Save Note
                    </button>
                </div>
            </form>
        </div>
        {% endif %}

        <div class="grid gap-4">
            {% for note in notes %}
            <div class="glass p-5 rounded-2xl">
                <h3 class="text-lg font-semibold text-white mb-2">{{ note.title }}</h3>
                <div class="prose prose-invert prose-sm text-gray-400 max-w-none">
                    {{ note.content|linebreaks }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

</div>
</div>
{% endblock %}